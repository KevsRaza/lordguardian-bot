"""
Cog d'utilitaires pour le bot
"""
import discord
from discord.ext import commands
from discord import app_commands
from src.core.logger import setup_logger  # â† CORRIGÃ‰
import datetime
import random

logger = setup_logger("Utilities")

class Utilities(commands.Cog):
    """Commandes utilitaires"""
    
    def __init__(self, bot):
        self.bot = bot
    
    @commands.command(name="serverinfo")
    async def server_info(self, ctx):
        """Affiche les informations du serveur"""
        guild = ctx.guild
        
        embed = discord.Embed(
            title=f"ğŸ“Š {guild.name}",
            color=discord.Color.blue()
        )
        
        embed.set_thumbnail(url=guild.icon.url if guild.icon else None)
        
        # PropriÃ©taire
        embed.add_field(name="ğŸ‘‘ PropriÃ©taire", value=guild.owner.mention, inline=True)
        
        # Statistiques
        embed.add_field(name="ğŸ“… CrÃ©Ã© le", value=f"<t:{int(guild.created_at.timestamp())}:D>", inline=True)
        embed.add_field(name="ğŸ†” ID", value=guild.id, inline=True)
        
        # Membres
        members = guild.members
        online = len([m for m in members if m.status != discord.Status.offline])
        bots = len([m for m in members if m.bot])
        
        embed.add_field(name="ğŸ‘¥ Membres", value=f"{guild.member_count} total\n{online} en ligne\n{bots} bots", inline=True)
        
        # Salons
        text_channels = len(guild.text_channels)
        voice_channels = len(guild.voice_channels)
        
        embed.add_field(name="ğŸ’¬ Salons", value=f"{text_channels} textuels\n{voice_channels} vocaux", inline=True)
        
        # RÃ´les
        embed.add_field(name="ğŸ¨ RÃ´les", value=f"{len(guild.roles)} rÃ´les", inline=True)
        
        # Boost
        if guild.premium_subscription_count > 0:
            boost_level = {0: "Aucun", 1: "Niveau 1", 2: "Niveau 2", 3: "Niveau 3"}
            embed.add_field(
                name="âœ¨ Boost",
                value=f"Niveau {boost_level.get(guild.premium_tier, '?')}\n{guild.premium_subscription_count} boosts",
                inline=True
            )
        
        await ctx.send(embed=embed)
    
    @commands.command(name="userinfo")
    async def user_info(self, ctx, member: discord.Member = None):
        """Affiche les informations d'un utilisateur"""
        member = member or ctx.author
        
        embed = discord.Embed(
            title=f"ğŸ‘¤ {member.display_name}",
            color=member.color if member.color else discord.Color.blue()
        )
        
        embed.set_thumbnail(url=member.display_avatar.url)
        
        # Informations de base
        embed.add_field(name="ğŸ“› Nom", value=f"{member.name}#{member.discriminator}", inline=True)
        embed.add_field(name="ğŸ†” ID", value=member.id, inline=True)
        
        # Dates
        embed.add_field(name="ğŸ“… Compte crÃ©Ã©", value=f"<t:{int(member.created_at.timestamp())}:R>", inline=True)
        embed.add_field(name="ğŸ“… Rejoint le", value=f"<t:{int(member.joined_at.timestamp())}:R>", inline=True)
        
        # Statut
        status_emojis = {
            discord.Status.online: "ğŸŸ¢",
            discord.Status.idle: "ğŸŸ¡", 
            discord.Status.dnd: "ğŸ”´",
            discord.Status.offline: "âš«"
        }
        
        status = status_emojis.get(member.status, "â“")
        embed.add_field(name="ğŸ“± Statut", value=f"{status} {str(member.status).title()}", inline=True)
        
        # RÃ´les
        if len(member.roles) > 1:
            roles = " ".join([role.mention for role in member.roles[1:]])  # Exclure @everyone
            embed.add_field(name="ğŸ¨ RÃ´les", value=roles[:1024] if len(roles) > 1024 else roles, inline=False)
        
        # Badges
        flags = member.public_flags
        badges = []
        
        if flags.staff: badges.append("ğŸ‘¨â€ğŸ’¼ Staff")
        if flags.partner: badges.append("ğŸ¤ Partenaire")
        if flags.hypesquad: badges.append("ğŸ  HypeSquad")
        if flags.bug_hunter: badges.append("ğŸ› Bug Hunter")
        if flags.hypesquad_balance: badges.append("âš–ï¸ HypeSquad Balance")
        if flags.hypesquad_bravery: badges.append("âš”ï¸ HypeSquad Bravery")
        if flags.hypesquad_brilliance: badges.append("ğŸ“ HypeSquad Brilliance")
        if flags.early_supporter: badges.append("ğŸ”¥ Early Supporter")
        if flags.verified_bot_developer: badges.append("ğŸ¤– Dev Bot VÃ©rifiÃ©")
        
        if badges:
            embed.add_field(name="ğŸ† Badges", value=" ".join(badges), inline=False)
        
        await ctx.send(embed=embed)
    
    @commands.command(name="avatar")
    async def get_avatar(self, ctx, member: discord.Member = None):
        """Affiche l'avatar d'un utilisateur"""
        member = member or ctx.author
        
        embed = discord.Embed(
            title=f"ğŸ–¼ï¸ Avatar de {member.display_name}",
            color=member.color if member.color else discord.Color.blue()
        )
        
        embed.set_image(url=member.display_avatar.url)
        embed.add_field(name="Lien", value=f"[Cliquez ici]({member.display_avatar.url})")
        
        await ctx.send(embed=embed)
    
    @commands.command(name="poll")
    @commands.has_permissions(manage_messages=True)
    async def create_poll(self, ctx, *, question: str):
        """
        CrÃ©e un sondage
        
        Usage: !poll "Question du sondage"
        """
        embed = discord.Embed(
            title="ğŸ“Š Sondage",
            description=question,
            color=discord.Color.purple()
        )
        embed.set_footer(text=f"Sondage crÃ©Ã© par {ctx.author}")
        
        message = await ctx.send(embed=embed)
        await message.add_reaction("âœ…")
        await message.add_reaction("âŒ")
    
    @commands.command(name="8ball")
    async def eight_ball(self, ctx, *, question: str):
        """
        Pose une question Ã  la boule magique
        
        Usage: !8ball [question]
        """
        responses = [
            "C'est certain.",
            "Sans aucun doute.",
            "Oui, dÃ©finitivement.",
            "Vous pouvez compter dessus.",
            "D'aprÃ¨s moi, oui.",
            "Probablement.",
            "Les perspectives sont bonnes.",
            "Oui.",
            "Les signes indiquent que oui.",
            "RÃ©ponse floue, rÃ©essayez.",
            "Redemandez plus tard.",
            "Mieux vaut ne pas vous le dire maintenant.",
            "Impossible de prÃ©dire maintenant.",
            "Concentrez-vous et redemandez.",
            "Ne comptez pas dessus.",
            "Ma rÃ©ponse est non.",
            "Mes sources disent non.",
            "Les perspectives ne sont pas bonnes.",
            "TrÃ¨s douteux."
        ]
        
        embed = discord.Embed(
            title="ğŸ± Boule Magique",
            color=discord.Color.dark_grey()
        )
        embed.add_field(name="Question", value=question, inline=False)
        embed.add_field(name="RÃ©ponse", value=random.choice(responses), inline=False)
        
        await ctx.send(embed=embed)
    
    @commands.command(name="ping")
    async def ping_command(self, ctx):
        """Affiche la latence du bot"""
        latency = round(self.bot.latency * 1000)
        
        embed = discord.Embed(
            title="ğŸ“ Pong!",
            description=f"Latence: **{latency}ms**",
            color=discord.Color.green() if latency < 100 else 
                  discord.Color.yellow() if latency < 300 else 
                  discord.Color.red()
        )
        
        await ctx.send(embed=embed)

async def setup(bot):
    await bot.add_cog(Utilities(bot))