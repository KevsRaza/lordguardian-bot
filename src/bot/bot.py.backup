"""
Bot principal GuildGreeter
"""
import discord
from discord.ext import commands
from discord.ui import Button, View
import json
import os
from pathlib import Path

class GuildGreeterBot(commands.Bot):
    """Bot Discord principal pour GuildGreeter"""
    
    def __init__(self, config):
        """
        Initialise le bot
        
        Args:
            config: Configuration du bot (objet Config)
        """
        # D√©finir les intents
        intents = discord.Intents.default()
        intents.members = True
        intents.message_content = True
        intents.guilds = True
        
        # Initialiser le bot
        super().__init__(
            command_prefix=getattr(config, 'prefix', '!'),
            intents=intents,
            help_command=None
        )
        
        self.config = config
        self.config_file = "config.json"
        
        # Enregistrer les √©v√©nements
        self.setup_events()
        
        # Enregistrer les commandes de base
        self.setup_commands()
    
    async def setup_hook(self):
        """Appel√© lors du setup du bot - charge les extensions"""
        from bot.extensions import load_extensions
        await load_extensions(self)
    
    def setup_events(self):
        """Configure les √©v√©nements du bot"""
        
        @self.event
        async def on_ready():
            print("\n" + "=" * 50)
            print(f"‚úÖ GuildGreeter connect√© en tant que {self.user}")
            print(f"üìä Serveurs: {len(self.guilds)}")
            print(f"üë• Membres: {sum(g.member_count for g in self.guilds)}")
            print(f"üéØ Pr√©fixe: {self.command_prefix}")
            print("=" * 50 + "\n")
        
        @self.event
        async def on_member_join(member: discord.Member):
            config = self.load_bot_config()

            welcome_channel = member.guild.get_channel(config["welcome_channel_id"]) if config["welcome_channel_id"] else None
            log_channel = member.guild.get_channel(config["log_channel_id"]) if config["log_channel_id"] else None
            role = member.guild.get_role(config["auto_role_id"]) if config["auto_role_id"] else None

            # Message personnalis√©
            message = config["welcome_message"] \
                .replace("{user}", member.mention) \
                .replace("{server}", member.guild.name)

            # Bouton Discord
            button = Button(label="üìú Lire les r√®gles", style=discord.ButtonStyle.primary)

            async def button_callback(interaction):
                await interaction.response.send_message(
                    "Merci de lire les r√®gles du serveur üìå",
                    ephemeral=True
                )

            button.callback = button_callback
            view = View()
            view.add_item(button)

            # Envoi du message de bienvenue
            if welcome_channel:
                embed = discord.Embed(
                    title="üéâ Nouveau membre",
                    description=message,
                    color=discord.Color.green()
                )
                await welcome_channel.send(embed=embed, view=view)

            # Auto-role
            if role:
                await member.add_roles(role)

            # Message priv√©
            try:
                await member.send(
                    f"üëã Bienvenue sur **{member.guild.name}** !\nNous sommes ravis de t'accueillir."
                )
            except discord.Forbidden:
                pass

            # Logs
            if log_channel:
                await log_channel.send(f"üì• {member} a rejoint le serveur.")
    
    def setup_commands(self):
        """Configure les commandes de base du bot"""
        
        @self.command()
        @commands.has_permissions(administrator=True)
        async def setwelcome(ctx, channel: discord.TextChannel):
            """D√©finit le canal de bienvenue"""
            config = self.load_bot_config()
            config["welcome_channel_id"] = channel.id
            self.save_bot_config(config)
            await ctx.send(f"‚úÖ Canal de bienvenue d√©fini : {channel.mention}")

        @self.command()
        @commands.has_permissions(administrator=True)
        async def setrole(ctx, role: discord.Role):
            """D√©finit le r√¥le automatique"""
            config = self.load_bot_config()
            config["auto_role_id"] = role.id
            self.save_bot_config(config)
            await ctx.send(f"‚úÖ R√¥le automatique d√©fini : {role.name}")

        @self.command()
        @commands.has_permissions(administrator=True)
        async def setlog(ctx, channel: discord.TextChannel):
            """D√©finit le canal de logs"""
            config = self.load_bot_config()
            config["log_channel_id"] = channel.id
            self.save_bot_config(config)
            await ctx.send(f"‚úÖ Canal de logs d√©fini : {channel.mention}")

        @self.command()
        @commands.has_permissions(administrator=True)
        async def setwelcomemsg(ctx, *, message):
            """D√©finit le message de bienvenue personnalis√©"""
            config = self.load_bot_config()
            config["welcome_message"] = message
            self.save_bot_config(config)
            await ctx.send("‚úÖ Message de bienvenue mis √† jour.")

        @self.command()
        async def testwelcome(ctx):
            """Teste le message de bienvenue"""
            member = ctx.author
            # Simuler l'√©v√©nement on_member_join
            await self.get_cog('on_member_join')(member) if hasattr(self, 'on_member_join') else None
            await ctx.send("‚úÖ Message de bienvenue test√©.")

        @self.command()
        async def ping(ctx):
            """V√©rifie la latence du bot"""
            latency = round(self.latency * 1000)
            await ctx.send(f"üèì Pong! Latence: {latency}ms")
    
    def load_bot_config(self):
        """Charge la configuration du bot depuis config.json"""
        if not os.path.exists(self.config_file):
            return {
                "welcome_channel_id": None,
                "auto_role_id": None,
                "log_channel_id": None,
                "welcome_message": "Bienvenue {user} sur **{server}** üéâ"
            }
        with open(self.config_file, "r", encoding="utf-8") as f:
            return json.load(f)

    def save_bot_config(self, data):
        """Sauvegarde la configuration du bot"""
        with open(self.config_file, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=4, ensure_ascii=False)